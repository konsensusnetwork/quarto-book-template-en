% typographical packages
\usepackage{microtype}
\usepackage{setspace}
%\tolerance=6000
%\hyphenpenalty=1000

% typographical settings for the body text
\setlength{\parskip}{0em}
\setlength{\parindent}{1em}
%\linespread{1.2}

% PHYSICAL DOCUMENT SETUP
\setstocksize{210mm}{148mm}
\settrimmedsize{210mm}{148mm}{*}
\setbinding{8mm}
\setlrmarginsandblock{10mm}{18mm}{*}
\setulmarginsandblock{22mm}{28mm}{*}

% FONTS
\usepackage{fontspec}
% \setmainfont{Alegreya}[
%     Path=./fonts/alegreya/,
%     Scale=1,
%     Extension=.ttf,
%     UprightFont=*-Regular,
%     BoldFont=*-Bold,
%     ItalicFont=*-Italic,
%     BoldItalicFont=*-BoldItalic
% ]

\setsansfont{stone-sans}[
    Path=./fonts/stone-sans/,
    Scale=1,
    Extension=.otf,
    UprightFont=*-Medium,
    BoldFont=*-Semibold,
    ItalicFont=*-MediumItalic,
    BoldItalicFont=*-SemiBoldItalic
]

\setmainfont{stone-serif}[
    Path=./fonts/stone-serif-itc-pro/,
    Scale=1,
    Extension=.OTF,
    UprightFont=*-Regular,
    BoldFont=*-SemiBd,
    ItalicFont=*-MediumIt,
    BoldItalicFont=*-SemiBdIt
]

\newfontfamily{\kallisto}{Kallisto}[
  Path=./fonts/kallisto/,
  Extension=.otf,
  UprightFont=* Medium,
  BoldFont=* Bold,
  ItalicFont=* Medium Italic,
  BoldItalicFont=* Bold Italic
]

% LETTRINE global options
\usepackage{lettrine}
\setcounter{DefaultLines}{3}
\renewcommand{\DefaultLoversize}{0.1}
\renewcommand{\DefaultLraise}{0}
\renewcommand{\LettrineTextFont}{}
\setlength{\DefaultFindent}{\fontdimen2\font}
\setlength{\DefaultNindent}{0em}

%\usepackage[footskip=8mm]{geometry}



% HEADER AND FOOTER MANIPULATION
% for normal pages
\nouppercaseheads
\headsep = 10mm
\makepagestyle{mystyle} 
\makeevenhead{mystyle}{\scriptsize\sffamily\mdseries\thepage}{}{}
\makeoddhead{mystyle}{{\scriptsize\sffamily\mdseries\leftmark}}{}{\scriptsize\sffamily\mdseries\thepage}
\makeevenfoot{mystyle}{}{}{}
\makeoddfoot{mystyle}{}{}{}
\makeatletter

% for pages where chapters begin
\makepagestyle{plain}
\makerunningwidth{plain}{\headwidth}
\makeevenfoot{plain}{}{}{}
\makeoddfoot{plain}{}{\scriptsize\sffamily\mdseries\thepage}{}
\pagestyle{mystyle}

\newif\ifmainmatter
\appto\mainmatter{\mainmattertrue}
\appto\backmatter{\mainmatterfalse}
\appto\appendix{\mainmatterfalse}

\renewcommand\chaptermark[1]{%
  \markboth{\MakeUppercase{%
    \ifmainmatter~\oldstylenums\thechapter.~\fi#1}}{}}%

% TOC
\usepackage[]{tocloft}
\renewcommand{\cftsectiondotsep}{\cftnodots}
\renewcommand{\cftpartfont}{\Large\sffamily\MakeUppercase}
\renewcommand{\cftchapterfont}{\small\sffamily}
\renewcommand{\cftsectionfont}{\Small\sffamily}
\renewcommand{\cftpartpagefont}{\Large\sffamily}
\renewcommand{\cftchapterpagefont}{\small}
\renewcommand{\cftchapterpresnum}{CHAPTER\space}
\renewcommand{\cftchapternumwidth}{7em}
\setlength{\cftchapterindent}{0em}
\setlength{\cftsectionindent}{7em}
\setsecnumdepth{chapter}
\setcounter{tocdepth}{0}


% Redefine footnote presentation
\makeatletter
\renewcommand\@makefntext[1]{%
  \noindent\hb@xt@2em{% <-- Box of fixed size for footnote number and space
    \@thefnmark\quad}% <-- Footnote number followed by a quad space
  \parbox[t]{\dimexpr\linewidth-2em}{#1}% <-- Parbox to control the width of footnote content
}
\makeatother

% layout check and fix
\checkandfixthelayout

% COUNTERS FOOTNOTES
\usepackage{chngcntr}
\counterwithout*{footnote}{chapter}

% TITLE FORMATTING
\usepackage{titlesec}
\titleformat
    {\chapter}[display]
    {\huge\sffamily}
    {\Large\sffamily\chaptertitlename\space\thechapter}
    {0pt}
    {\vspace{28pt}}

\titleformat
  {\section}[block]
  {\sffamily\large\bfseries}
  {}
  {0pt}
  {}
  
\titlespacing*{\section}{0pt}{2em}{0.5em}

\titleformat{\subsection}{\sffamily\bfseries}{}{}{}
\titlespacing*{\subsection}{0pt}{2em}{0em}

% QUOTE FORMATTING
\renewenvironment{quote}%
               {\list{}{\rightmargin=.6cm\leftmargin=.6cm}%
                \itshape \item[]}% <- The effect of \samepage is local!!!
               {\endlist}

% LAYOUT CHECK AND FIX
\checkandfixthelayout

% CUSTOM TITLE PAGE
\makeatletter
\def\@maketitle{%
  % the half title page
  \pagestyle{empty}
  \halftitlepage
  \cleardoublepage

  % the title page
  \titleM
  \clearpage

  % the copyright page
  \copyrightpage
  \cleardoublepage
  \pagestyle{mystyle}
}
\makeatother
% END PREAMBLE
